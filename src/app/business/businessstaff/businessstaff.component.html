<section class="content">
    <div class="container-fluid">
        <div class="block-header">
            <div class="row">
                <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                    <ul class="breadcrumb breadcrumb-style ">
                        <li class="breadcrumb-item">
                            <h4 class="page-title">Business Staff</h4>
                        </li>
                        <li class="breadcrumb-item bcrumb-1">
                            <a routerLink="/business/businesses">
                                <i class="fas fa-home"></i> Business</a>
                        </li>
                        <li class="breadcrumb-item active">Staff</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-4 mt-3 col-md-12 col-sm-12">
                <div class="card py-3 px-3">
                    <div class="row ">
                        <div class="" style="width: 65%; margin-right: 5%; margin-left: 5%;">
                            <input type="text" class="form-control"
                                placeholder="Filter by name, username, email or id..." style="width: 100%;"
                                (keyup)="searchStaff($event)" />
                        </div>
                        <div class="pl-0 " style="width: 25%;">
                            <button type="button" class="btn btn-primary" data-toggle="modal"
                                data-target="#addStaffModal">
                                <i class="fas fa-plus mr-1"></i> Add
                            </button>
                        </div>
                    </div>

                    <div class="form-group form-float mt-3">
                        <div class="form-line">
                            <div class="text-center mt-3" *ngIf="staff.length < 1">
                                <h6>No staff found</h6>
                            </div>
                            <ng-container *ngFor="let member of staff">
                                <div [ngClass]="[ member?.user?.id == currentStaff?.user?.id ? 'col-12 bg-light-success mt-2 br-5 clickable' : 'col-12 bg-light mt-2 br-5 clickable']"
                                    *ngIf="member?.status?.name != 'Removed'" (click)="setCurrentStaff(member)">
                                    <div class="row px-2 pt-3 pb-2 justify-content-between">
                                        <span class="font-16 text-capitalize">{{member?.user.first_name}}
                                            {{member?.user.last_name}}</span>
                                        <span class="pr-1 pull-right">
                                            <mat-icon class="col-cyan mr-1">visibility</mat-icon>
                                        </span>
                                    </div>
                                </div>
                            </ng-container>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-8 mt-3">
                <mat-card class="full-height mb-4">
                    <div class="row justify-content-between">
                        <div class="col-lg-1 col-md-2 col-4">
                            <i class="col-cyan fa fa-user-circle fa-3x"></i>
                        </div>
                        <div class="col-lg-5 col-md-5 col-8 pl-2">
                            <h5 class="ml-1 font-20 mb-0">{{currentStaff?.user.first_name}}
                                {{currentStaff?.user.last_name}}</h5>
                            <p class="ml-1 ">
                                <span class="mr-2 text-capitalize">{{currentStaff?.role.name}}</span>
                                <span
                                    [ngClass]="[ currentStaff?.status?.name == 'Active' ? 'badge btn-success' : 'badge bg-orange']">{{currentStaff?.status?.name}}</span>
                            </p>
                        </div>

                        <!-- <span fxFlex></span> -->
                        <div class="col-lg-6 col-md-5 col-12 justify-content-center text-center">
                            <!-- <button mat-button *ngIf="(currentStaff?.role.name.toLowerCase() != 'owner' && currentStaff?.status?.name != 'Blacklisted' )" (click)="updateStaffStatus(8)">
                                    <i class="col-red mr-1 fas fa-ban"></i>Block
                                </button>
                                <button mat-button *ngIf="(currentStaff?.role.name.toLowerCase() != 'owner' && currentStaff?.status?.name == 'Blacklisted' )" (click)="updateStaffStatus(4)">
                                    <i class="col-cyan mr-1 fas fa-unlock-alt"></i>Unblock
                                </button>
                                <button mat-button *ngIf="(currentStaff?.role.name.toLowerCase() != 'owner' && currentStaff?.status?.name != 'Removed' )" (click)="removeStaff()">
                                    <i class="col-red mr-1 fas fa-trash"></i>Remove
                                </button> -->
                            <button mat-button data-toggle="modal" data-target="#editStaffRoleModal"
                                *ngIf="currentStaff?.role.name.toLowerCase() != 'owner'">
                                <i class="col-cyan mr-1 fas fa-edit"></i>Change Role
                            </button>
                            <button mat-button data-toggle="modal" data-target="#editStaffStatusModal"
                                *ngIf="currentStaff?.role.name.toLowerCase() != 'owner'">
                                <i class="col-cyan mr-1 fas fa-edit"></i>Change Status
                            </button>
                        </div>

                    </div>
                    <mat-divider></mat-divider>
                    <mat-card-content>
                        <div class="row px-4 mt-4 justify-content-center text-center">
                            <h5>Assigned Permissions</h5>
                        </div>
                        <div class="row px-4 justify-content-center text-center"
                            *ngIf="currentStaff?.role?.name.toLowerCase() != 'owner'">
                            <ng-container *ngFor="let permission of rolePermissions">
                                <div class="col-12 col-lg-12 col-md-12 mt-3 ">
                                    <span class="badge col-cyan pt-3 pb-3"
                                        style="width: 100%; text-align: left !important;">{{permission.name}}<i
                                            class="fas fa-times col-red pull-right clickable mr-1"></i></span>
                                </div>
                            </ng-container>
                        </div>
                        <div class="row px-4 justify-content-center text-center"
                            *ngIf="currentStaff?.role?.name.toLowerCase() == 'owner'">
                            <ng-container *ngFor="let permission of rolePermissions">
                                <div class="col-12 col-lg-12 col-md-12 mt-3 ">
                                    <span class="badge col-cyan pt-3"
                                        style="width: 100%; text-align: left !important;">{{permission.name}}<mat-checkbox class="example-margin pull-right" checked="checked"></mat-checkbox></span>
                                </div>
                            </ng-container>
                        </div>
                    </mat-card-content>
                </mat-card>
            </div>
        </div>
    </div>
</section>

<!-- add staff modal -->
<div class="modal fade " tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true"
    id="addStaffModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="mt-3 mb-3 ml-3" id="myLargeModalLabel">Add a staff to your business</h5>
                <button type="button" class="close mt-2 mb-3 mr-2" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="centered-content mt-2">
                    <div>
                        <form #firstForm="ngForm">
                            <div class="form-group form-float mb-2" *ngIf="!selectedMember">
                                <div class="row col-12 text-center">
                                    <p class="font-bold font-12">Search for Member to be added</p>
                                </div>
                                <div class="form-line">
                                    <mat-form-field class="example-full-width" appearance="outline">
                                        <mat-label>Search for Member</mat-label>
                                        <input matInput type="text" (keyup)="findMembers($event)"
                                            placeholder="Search with name, email, phone or ID of member" minlength="3"
                                            required name="searchtext" [(ngModel)]="searchText" #searchtext="ngModel">
                                        <mat-icon matSuffix>search</mat-icon>
                                        <mat-error
                                            *ngIf="!searchtext.valid && (searchtext.dirty || searchtext.touched)">
                                            please enter at least 3 characters to search with
                                        </mat-error>
                                    </mat-form-field>
                                </div>
                            </div>

                            <div class="text-center mt-2 mb-2" *ngIf="(searchText && searchedMembers.length < 1)">
                                <h6>Member Not found</h6>
                            </div>

                            <div class="form-group form-float mt-1"
                                *ngIf="(searchedMembers.length > 0 && !selectedMember)">
                                <div class="form-line">
                                    <div class="row col-12 text-center">
                                        <p class="">Member search Result(s)</p>
                                    </div>
                                    <div style="max-height: 500px; overflow-y: scroll;">
                                        <div class="col-12 bg-light mt-1 br-5 clickable"
                                            *ngFor="let member of searchedMembers" (click)="setSelectedMember(member)">
                                            <div class="row px-4 py-3 justify-content-between">
                                                <span class="">
                                                    <mat-icon class="col-cyan mr-1">account_circle</mat-icon>
                                                </span>
                                                <span class="font-16 text-capitalize"
                                                    style="text-align: right;">{{member?.first_name}}
                                                    {{member?.last_name}}</span>
                                            </div>
                                            <!-- <div class="row px-4 pb-1 justify-content-between">
                                                    <span class="" >{{member?.email}}</span>
                                                    <span class="" style="text-align: right;">{{member?.phone_number}}</span>
                                                </div> -->
                                        </div>
                                    </div>

                                </div>
                            </div>

                            <div class="form-group form-float " *ngIf="selectedMember">
                                <div class="form-line">
                                    <div class="row col-12 text-center">
                                        <p class="font-bold font-12">Selected Member</p>
                                    </div>
                                    <div class="col-12 br-5 bg-light-success">
                                        <div class="row px-4 py-3 justify-content-between">
                                            <span class="">
                                                <mat-icon class="col-cyan mr-1">account_circle</mat-icon>
                                            </span>
                                            <span class="font-18 text-capitalize"
                                                style="text-align: right;">{{selectedMember?.first_name}}
                                                {{selectedMember?.last_name}}</span>
                                            <span (click)="removeSelectedMember()"><i class="fas fa-times col-red"
                                                    style="cursor: pointer;"></i></span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <p class="font-bold font-12">Select a staff role for Member</p>

                            <div class="form-group form-float mb-0">
                                <div class="form-line">
                                    <mat-form-field class="example-full-width pb-0" appearance="outline">
                                        <mat-label>Select Role
                                        </mat-label>
                                        <mat-select required>
                                            <ng-container *ngFor="let role of roles" class="pb-0">
                                                <mat-option [value]="'role.name'" class="text-capitalize"
                                                    *ngIf="role.name.toLowerCase() != 'owner'"
                                                    (click)="setSelectedRole(role)">
                                                    {{role?.name}}
                                                </mat-option>
                                            </ng-container>
                                        </mat-select>
                                        <mat-icon matSuffix>assignment_ind</mat-icon>
                                    </mat-form-field>
                                </div>
                            </div>

                            <p class="font-bold font-12">Create a new staff role (Optional)</p>
                            <mat-accordion>
                                <mat-expansion-panel>
                                    <mat-expansion-panel-header>
                                        <mat-panel-title>
                                            <i class="fa fa-plus mr-2 mt-1 col-cyan"></i> Role
                                        </mat-panel-title>
                                        <mat-panel-description>
                                            Create new role
                                        </mat-panel-description>
                                    </mat-expansion-panel-header>

                                    <div class="row col-12 text-center mt-2">
                                        <p class="font-bold font-12">Enter name for new role and select permissions to
                                            assign</p>
                                    </div>
                                    <div class="form-line">
                                        <mat-form-field class="example-full-width" appearance="outline">
                                            <mat-label>New role name</mat-label>
                                            <input matInput type="text"
                                                placeholder="enter name for new role e.g manager1, IT supervisor"
                                                minlength="3" required name="newrole" [(ngModel)]="newRole"
                                                #newrole="ngModel">
                                            <!-- <mat-icon matSuffix>search</mat-icon> -->
                                            <mat-error *ngIf="!newrole.valid && (newrole.dirty || newrole.touched)">
                                                please enter at least 3 characters for role name
                                            </mat-error>
                                        </mat-form-field>
                                    </div>
                                    <div class="row col-12 text-center">
                                        <p class="font-bold font-12">Select permissions to be assigned to role</p>
                                    </div>
                                    <div class="row justify-content-center">
                                        <ng-container *ngFor="let permission of businessPermissions">
                                            <div class="col-12 col-lg-6 col-md-6 mt-3">
                                                <span class="badge bg-cyan ml-2"
                                                    style="width: 75%; text-align: left !important;">{{permission.name}}</span>
                                                <mat-checkbox class="example-margin"
                                                    (click)="addOrRemoveRolePermissions(permission)"></mat-checkbox>
                                            </div>
                                        </ng-container>
                                    </div>
                                    <div class="row px-4 mt-4 justify-content-center text-center">
                                        <h6>Assigned Permissions</h6>
                                    </div>
                                    <div class="row justify-content-center">
                                        <ng-container *ngFor="let permission of assignedPermissions">
                                            <div class="col-12 col-lg-6 col-md-6 mt-3 ">
                                                <span class="badge col-cyan ml-2"
                                                    style="width: 100%; text-align: left !important;">{{permission.name}}</span>
                                            </div>
                                        </ng-container>
                                    </div>
                                    <div class="text-right button-demo mt-4">
                                        <button class="btn btn-success btn-border-radius waves-effect"
                                            [disabled]="!(newRole && assignedPermissions.length > 0)"
                                            (click)="createStaffRole()">Create Role</button>
                                    </div>
                                </mat-expansion-panel>
                            </mat-accordion>
                        </form>
                    </div>

                    <div class="text-right button-demo mt-4">
                        <button class="btn btn-success btn-border-radius waves-effect"
                            [disabled]="!(selectedRole && selectedMember)" (click)="addBusinessStaff()">Add
                            Staff</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger waves-effect" #closebutton
                    data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade " tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true"
    id="editStaffRoleModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="mt-3 mb-3 ml-3" id="myLargeModalLabel">Edit Staff Role</h5>
                <button type="button" class="close mt-2 mb-3 mr-2" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="centered-content mt-2">
                    <div>
                        <form #firstForm="ngForm">
                            <div class="form-group form-float">
                                <div class="form-line">
                                    <div class="col-12 br-5 bg-light-success">
                                        <div class="row px-4 py-3 justify-content-between">
                                            <span class="">
                                                <mat-icon class="col-cyan mr-1">account_circle</mat-icon>
                                            </span>
                                            <span class="font-18 text-capitalize"
                                                style="text-align: right;">{{currentStaff?.user.first_name}}
                                                {{currentStaff?.user.last_name}}</span>
                                            <span class="font-16 text-capitalize">{{currentStaff?.role.name}}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row col-12 text-center mt-3">
                                <p class="font-bold font-12">Select new Role for staff</p>
                            </div>
                            <div class="form-group form-float mb-2">
                                <div class="form-line">
                                    <mat-form-field class="example-full-width" appearance="outline">
                                        <mat-label>Select new Role
                                        </mat-label>
                                        <mat-select required>
                                            <ng-container *ngFor="let role of roles">
                                                <mat-option [value]="'role.name'" class="text-capitalize"
                                                    *ngIf="!(role?.name.toLowerCase() == 'owner' ||  role?.name == currentStaff?.role.name)"
                                                    (click)="setSelectedRole(role)">
                                                    {{role?.name}}
                                                </mat-option>
                                            </ng-container>
                                        </mat-select>
                                        <mat-icon matSuffix>assignment_ind</mat-icon>
                                    </mat-form-field>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="text-right button-demo">
                        <button class="btn btn-success btn-border-radius waves-effect" [disabled]="!selectedRole"
                            (click)="editStaffRole()">Confirm Edit</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger waves-effect" #editmodalclose
                    data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade " tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true"
    id="editStaffStatusModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="mt-3 mb-3 ml-3" id="myLargeModalLabel">Edit Staff Status</h5>
                <button type="button" class="close mt-2 mb-3 mr-2" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="centered-content mt-2">
                    <div>
                        <form #firstForm="ngForm">
                            <div class="form-group form-float">
                                <div class="form-line">
                                    <div class="col-12 br-5 bg-light-success">
                                        <div class="row px-4 py-3 justify-content-between">
                                            <span class="">
                                                <mat-icon class="col-cyan mr-1">account_circle</mat-icon>
                                            </span>
                                            <span class="font-18 text-capitalize"
                                                style="text-align: right;">{{currentStaff?.user.first_name}}
                                                {{currentStaff?.user.last_name}}</span>
                                            <span class="font-16 text-capitalize">{{currentStaff?.role.name}}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row col-12 text-center mt-3">
                                <p class="font-bold font-12">Select new Status for staff</p>
                            </div>
                            <div class="form-group form-float mb-2">
                                <div class="form-line">
                                    <mat-form-field class="example-full-width" appearance="outline">
                                        <mat-label>Select new Status
                                        </mat-label>
                                        <mat-select required>
                                            <ng-container *ngFor="let status of statuses">
                                                <mat-option [value]="'status.name'" class="text-capitalize"
                                                    (click)="setSelectedStatus(status)">
                                                    {{status?.name}}
                                                </mat-option>
                                            </ng-container>
                                        </mat-select>
                                        <mat-icon matSuffix>assignment_ind</mat-icon>
                                    </mat-form-field>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="text-right button-demo">
                        <button class="btn btn-success btn-border-radius waves-effect" [disabled]="!selectedStatus"
                            (click)="editStaffStatus()">Confirm Edit</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger waves-effect" #editmodalclosestatus
                    data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
